(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{394:function(t,a,s){t.exports=s.p+"assets/img/lane-1.4bc8cc5b.png"},395:function(t,a,s){t.exports=s.p+"assets/img/lane-2.f959ccde.png"},396:function(t,a,s){t.exports=s.p+"assets/img/lane-3.2241d746.png"},397:function(t,a,s){t.exports=s.p+"assets/img/lane-4.c61a08b1.png"},398:function(t,a,s){t.exports=s.p+"assets/img/lane-5.8e5219af.png"},479:function(t,a,s){"use strict";s.r(a);var n=s(14),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"实现同步调度流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现同步调度流程"}},[t._v("#")]),t._v(" 实现同步调度流程")]),t._v(" "),a("p",[t._v("更新到底是同步还是异步？")]),t._v(" "),a("div",{staticClass:"language-jsx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("App")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onClick")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("a")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省略其他代码")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("当前的现状：")]),t._v(" "),a("ul",[a("li",[t._v("从触发更新到 render，再到 commit 都是同步的")]),t._v(" "),a("li",[t._v("多次触发更新会重复多次更新流程")])]),t._v(" "),a("p",[t._v("可以改进的地方："),a("code",[t._v("多次触发更新，只进行一次更新流程")])]),t._v(" "),a("p",[t._v("Batched Updates（批处理）：多次触发更新，只进行一次更新流程")]),t._v(" "),a("p",[t._v("将多次更新合并为一次，理念上有点类似防抖、节流，我们需要考虑合并的时机是：")]),t._v(" "),a("ul",[a("li",[t._v("宏任务？")]),t._v(" "),a("li",[t._v("微任务？")])]),t._v(" "),a("p",[t._v("用三款框架实现Batched Updates，打印结果不同：")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://codesandbox.io/s/react-concurrent-mode-demo-forked-t8mil?file=/src/index.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("React"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://codesandbox.io/s/crazy-rosalind-wqj0c?file=/src/App.vue",target:"_blank",rel:"noopener noreferrer"}},[t._v("Vue3"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://svelte.dev/repl/1e4e4e44b9ca4e0ebba98ef314cfda54?version=3.44.1",target:"_blank",rel:"noopener noreferrer"}},[t._v("Svelte"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("结论：React批处理的时机既有宏任务，也有微任务（Vue3 和 Svelte 都是微任务）")]),t._v(" "),a("h2",{attrs:{id:"新增调度阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#新增调度阶段"}},[t._v("#")]),t._v(" 新增调度阶段")]),t._v(" "),a("p",[t._v("既然我们需要"),a("code",[t._v("多次触发更新，只进行一次更新流程")]),t._v("，意味着我们要将更新合并，所以在：")]),t._v(" "),a("ul",[a("li",[t._v("render 阶段")]),t._v(" "),a("li",[t._v("commit 阶段")])]),t._v(" "),a("p",[t._v("的基础上增加"),a("code",[t._v("schedule")]),t._v("阶段（调度阶段）")]),t._v(" "),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s(394)}}),t._v(" "),a("h2",{attrs:{id:"对-update-的调整"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#对-update-的调整"}},[t._v("#")]),t._v(" 对 update 的调整")]),t._v(" "),a("p",[a("code",[t._v("多次触发更新，只进行一次更新流程")]),t._v("中"),a("code",[t._v("多次触发更新")]),t._v("意味着对于同一个 fiber，会创建多个 update：")]),t._v(" "),a("div",{staticClass:"language-jsx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onClick")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建3个update")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateCount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("count")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateCount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("count")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateCount")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("count")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[a("code",[t._v("多次触发更新，只进行一次更新流程")]),t._v("，意味着要达成3个目标：")]),t._v(" "),a("ul",[a("li",[t._v("需要实现一套优先级机制，每个更新都拥有优先级")]),t._v(" "),a("li",[t._v("需要能够合并一个宏任务/微任务中触发的所有更新")]),t._v(" "),a("li",[t._v("需要一套算法，用于决定哪个优先级优先进入 render 阶段")])]),t._v(" "),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s(395)}}),t._v(" "),a("h2",{attrs:{id:"实现-lane-模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现-lane-模型"}},[t._v("#")]),t._v(" 实现 Lane 模型")]),t._v(" "),a("p",[t._v("采用二进制位表示 Lane 可以更方便的表示不同 Lane 的集合")]),t._v(" "),a("p",[t._v("Lane 模型包括：")]),t._v(" "),a("ul",[a("li",[t._v("lane（二进制位，代表 update 优先级）")]),t._v(" "),a("li",[t._v("lanes（二进制位，代表 lane 的集合）")])]),t._v(" "),a("h3",{attrs:{id:"lane-的产生"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#lane-的产生"}},[t._v("#")]),t._v(" lane 的产生")]),t._v(" "),a("p",[t._v("对于不同情况触发的更新，产生 lane。为后续不同事件产生不同优先级更新做准备。")]),t._v(" "),a("p",[t._v("如何知道哪些 lane 被消费，还剩哪些 lane 没被消费？")]),t._v(" "),a("p",[t._v("对 FiberRootNode 的改造：")]),t._v(" "),a("p",[t._v("需要增加如下字段：")]),t._v(" "),a("ul",[a("li",[t._v("代表所有未被消费的 lane 的集合 （pendingLanes）")]),t._v(" "),a("li",[t._v("代表本次更新消费的 lane （finishedLane）")])]),t._v(" "),a("p",[t._v("大致流程图如下：")]),t._v(" "),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s(396)}}),t._v(" "),a("h2",{attrs:{id:"实现调度阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现调度阶段"}},[t._v("#")]),t._v(" 实现调度阶段")]),t._v(" "),a("ul",[a("li",[t._v("实现"),a("code",[t._v("某些判断机制")]),t._v("，选出一个lane")]),t._v(" "),a("li",[t._v("实现类似防抖、节流的效果，合并宏/微任务中触发的更新")])]),t._v(" "),a("p",[t._v("大致流程图：")]),t._v(" "),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s(397)}}),t._v(" "),a("h2",{attrs:{id:"render阶段的改造"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#render阶段的改造"}},[t._v("#")]),t._v(" render阶段的改造")]),t._v(" "),a("p",[t._v("processUpdateQueue 方法消费 update 时需要考虑：")]),t._v(" "),a("ul",[a("li",[t._v("lane 的因素")]),t._v(" "),a("li",[t._v("update 现在是一条链表，需要遍历")])]),t._v(" "),a("h2",{attrs:{id:"commit阶段的改造"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#commit阶段的改造"}},[t._v("#")]),t._v(" commit阶段的改造")]),t._v(" "),a("p",[t._v("移除"),a("code",[t._v("本次更新被消费的lane")])]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("img",{staticClass:"zoom-custom-imgs",attrs:{src:s(398)}}),t._v(" "),a("SideTitle",{attrs:{page:t.$page}})],1)}),[],!1,null,null,null);a.default=e.exports}}]);