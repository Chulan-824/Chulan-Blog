<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue设计与实现笔记 | 前端知识体系构建</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="楚岚博客">
    
    <link rel="preload" href="/Chulan-Blog/assets/css/0.styles.b771745a.css" as="style"><link rel="preload" href="/Chulan-Blog/assets/js/app.fcfd34cd.js" as="script"><link rel="preload" href="/Chulan-Blog/assets/js/3.cc92fa6a.js" as="script"><link rel="preload" href="/Chulan-Blog/assets/js/5.4311ba71.js" as="script"><link rel="preload" href="/Chulan-Blog/assets/js/16.c7bb5e85.js" as="script"><link rel="prefetch" href="/Chulan-Blog/assets/js/10.7d594c63.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/11.c04ab1a8.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/12.9139256a.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/13.1a856ab2.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/14.c8eeeffb.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/15.10723151.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/17.b08b2728.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/18.82e87477.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/19.97f20673.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/2.81370427.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/20.b583d1f0.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/21.76d8282c.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/22.2320ebe1.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/23.cc713f01.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/24.ed7dfde3.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/25.bd97bf13.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/26.88d2f155.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/27.0b172a03.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/28.8844d1ce.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/29.34342f7b.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/30.2ae3b7e8.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/31.ce2f16ad.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/32.76d45a13.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/33.01600f0d.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/34.9408b45c.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/35.b8db733a.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/36.26701b69.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/37.184637de.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/38.34825831.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/39.3acfc215.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/4.52d892ee.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/40.d2c6c02e.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/41.9278c432.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/42.7e5bf270.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/43.129f1001.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/44.adb528bc.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/45.b6d49f7d.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/46.155f6d85.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/47.90aff817.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/48.81e00989.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/49.fd02399b.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/50.71b42de0.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/51.d091d8d5.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/52.b982b1d2.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/53.ee514913.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/54.77c07b06.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/6.15ffeb16.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/7.ff19481f.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/8.93b947d5.js"><link rel="prefetch" href="/Chulan-Blog/assets/js/9.c541ee12.js">
    <link rel="stylesheet" href="/Chulan-Blog/assets/css/0.styles.b771745a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Chulan-Blog/" class="home-link router-link-active"><!----> <span class="site-name">前端知识体系构建</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Chulan-Blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/Chulan-Blog/js/base/inherit/" class="nav-link">
  Js
</a></div><div class="nav-item"><a href="/Chulan-Blog/engineering/module/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/Chulan-Blog/hand-wirte-code/promise/" class="nav-link">
  手写代码
</a></div><div class="nav-item"><a href="/Chulan-Blog/Http/base/" class="nav-link">
  计算机网络
</a></div><div class="nav-item"><a href="/Chulan-Blog/Git/rebase/" class="nav-link">
  Git
</a></div><div class="nav-item"><a href="/Chulan-Blog/react-design-principle/overview/know/" class="nav-link">
  React设计原理
</a></div><div class="nav-item"><a href="/Chulan-Blog/vue/concept/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Vue设计与实现笔记
</a></div><div class="nav-item"><a href="/Chulan-Blog/english/elementary/noun/" class="nav-link">
  English Grammar
</a></div><div class="nav-item"><a href="https://github.com/Chulan-824" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Chulan-Blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/Chulan-Blog/js/base/inherit/" class="nav-link">
  Js
</a></div><div class="nav-item"><a href="/Chulan-Blog/engineering/module/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/Chulan-Blog/hand-wirte-code/promise/" class="nav-link">
  手写代码
</a></div><div class="nav-item"><a href="/Chulan-Blog/Http/base/" class="nav-link">
  计算机网络
</a></div><div class="nav-item"><a href="/Chulan-Blog/Git/rebase/" class="nav-link">
  Git
</a></div><div class="nav-item"><a href="/Chulan-Blog/react-design-principle/overview/know/" class="nav-link">
  React设计原理
</a></div><div class="nav-item"><a href="/Chulan-Blog/vue/concept/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Vue设计与实现笔记
</a></div><div class="nav-item"><a href="/Chulan-Blog/english/elementary/noun/" class="nav-link">
  English Grammar
</a></div><div class="nav-item"><a href="https://github.com/Chulan-824" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Chulan-Blog/vue/concept/" aria-current="page" class="active sidebar-link">Vue设计与实现笔记</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue设计与实现笔记"><a href="#vue设计与实现笔记" class="header-anchor">#</a> Vue设计与实现笔记</h1> <h2 id="设计理念"><a href="#设计理念" class="header-anchor">#</a> 设计理念</h2> <h3 id="命令式和声明式"><a href="#命令式和声明式" class="header-anchor">#</a> 命令式和声明式</h3> <p>用两种编程范式实现一下需求</p> <ol><li>获取 id 为 app 的 div 标签</li> <li>它的文本内容为 hello world</li> <li>为其绑定点击事件</li> <li>当点击时弹出提示：ok</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 命令式</span>
<span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>            <span class="token comment">// 获取 div</span>
div<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'hello world'</span>                         <span class="token comment">// 设置文本内容</span>
div<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// 绑定点击事件</span>

<span class="token comment">// 声明式</span>
<span class="token operator">&lt;</span>div @click<span class="token operator">=</span><span class="token string">&quot;() =&gt; alert('ok')&quot;</span><span class="token operator">&gt;</span>hello world<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre></div><p>总结：</p> <ol><li>命令式关注过程，声明式关注结果</li> <li>Vue 内部实现一定是命令式，而暴漏给用户的确实更加声明式</li></ol> <h3 id="性能与可维护性"><a href="#性能与可维护性" class="header-anchor">#</a> 性能与可维护性</h3> <p>以上述例子为例，将 hello world 修改为 hello vue3，不同范式下修改方式也不同</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 命令式</span>
div<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">'hello vue3'</span>                          <span class="token comment">// 直接修改</span>

<span class="token comment">// 声明式</span>
<span class="token operator">&lt;</span>div @click<span class="token operator">=</span><span class="token string">&quot;() =&gt; alert('ok')&quot;</span><span class="token operator">&gt;</span>hello world<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>       <span class="token comment">// 之前</span>
<span class="token operator">&lt;</span>div @click<span class="token operator">=</span><span class="token string">&quot;() =&gt; alert('ok')&quot;</span><span class="token operator">&gt;</span>hello vue3<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>        <span class="token comment">// 之后</span>

<span class="token comment">// 对于框架来说，为了实现最优的更新性能，它需要找到前后的差异并只更新变化的地方，但是最终完成这次更新的代码仍然是</span>
div<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">'hello vue3'</span> 
</code></pre></div><p>由上述例子可知，性能更好的是直接修改 <code>div.textContent = 'hello vue3'</code>，如果我们把直接修改的性能开销定义为 A，把找差异性能开销定义为 B，那么有</p> <ul><li>命令式代码的更新性能消耗 = A</li> <li>声明式代码的更新性能消耗 = B + A</li></ul> <p>声明式代码最理想的情况就是 B 开销为 0，声明式代码和命令式代码相同，但是为什么Vue依然不直接采用命令式代码的原因就是<code>声明式代码的可维护性更强</code></p> <p>而框架（Vue）要做的就是在保持可维护性的同时，让性能损失最小化</p> <h3 id="虚拟-dom-性能到底如何"><a href="#虚拟-dom-性能到底如何" class="header-anchor">#</a> 虚拟 DOM 性能到底如何</h3> <p>上文提到需要将找出性能差异性能开销降到最低，这就是接下来虚拟 DOM 要解决的问题</p> <p>为什么是虚拟 DOM 而不是真实 DOM？</p> <p>因为直接操作真实 DOM 性能开销非常大，虚拟 DOM 本质上就是js对象</p> <p>操作真实 DOM 不只有 <code>document.createElement</code> 之类的方法，还有 <code>innerHTML</code>，所以需要单独讨论</p> <p>那么在第一创建页面的时候性能对比，如下</p> <img src="/Chulan-Blog/assets/img/vdom1.bd3b2a67.png" class="zoom-custom-imgs"> <p>创建页面的时候，三者没有数量级上的差别，所以区别不大</p> <p>接着我们在看更新页面时的性能对比，如下</p> <img src="/Chulan-Blog/assets/img/vdom2.750a0e99.png" class="zoom-custom-imgs"> <ul><li>innerHTML 需要重新销毁旧的 DOM，然后重新创建所有新 DOM</li> <li>虚拟 DOM 只需要在上述基础增加 Diff 找出必要更新的 DOM 进行更新即可</li></ul> <p>在更新页面的时候，虚拟 DOM 的优势会比其他两者要大</p> <p>那么如果我们的页面元素变得非常大的情况，更新和需要的性能消耗就如下所示</p> <img src="/Chulan-Blog/assets/img/vdom3.6eac5a39.png" class="zoom-custom-imgs"> <h4 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h4> <img src="/Chulan-Blog/assets/img/vdom4.9426f020.png" class="zoom-custom-imgs"> <h3 id="运行时和编译时"><a href="#运行时和编译时" class="header-anchor">#</a> 运行时和编译时</h3> <p>比如现在设计一个运行时框架，有一个 Render 函数，用户可以为该函数提供一个树形结构对象，然后 Render 函数会根据该对象递归渲染 DOM 元素</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">'hello world'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Render</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>tag<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> obj<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> text <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
    el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 数组，递归调用 Render，使用 el 作为 root 参数</span>
    obj<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Render</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将元素添加到 root</span>
  root<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 渲染到 body 下</span>
<span class="token function">Render</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
</code></pre></div><p>这里不涉及任何额外操作，和学习额外的知识，就是定义对象，使用渲染函数渲染。但是有一个问题，就是定义对象去描述 HTML 方法太麻烦了，而且不直观，能不能直接使用 HTML 标签去写呢？达到以下效果</p> <img src="/Chulan-Blog/assets/img/runTime1.938dc1c5.png" class="zoom-custom-imgs"> <p>为此我们可以编写一个叫 Compiler 的程序，作用就是把 HTML 的字符串编译成上述 Render 函数需要用的树形结果的数据对象，然后执行代码逻辑就是</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;div&gt;
  &lt;span&gt;hello world&lt;/span&gt;
&lt;/div&gt;
</span><span class="token template-punctuation string">`</span></span>
<span class="token comment">// 调用 Compiler 编译得到树型结构的数据对象</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">Compiler</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
<span class="token comment">// 再调用 Render 进行渲染</span>
<span class="token function">Render</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
</code></pre></div><p>这是，上面的代码就类似于<code>运行时+编译时</code>,其实也就是<code>运行时编译</code>， 在代码运行的时候才开始编译，而这会产生一定性能开销</p> <p>那么，可不可以不要这个性能开销呢，在构建的时候就编译好，然后直接运行运行时代码就可以，既然直接可以提前编译的话，那直接编译成命令式代码不是更好吗？</p> <p>这里就要说一下三种模式下的不同了</p> <ul><li>运行时：无法分析用户提供的内容</li> <li>编译时：可以分析用户提供的内容，性能更好，灵活性差</li> <li>运行时 + 编译时：在保证灵活性的基础上经可能去优化</li></ul> <h2 id="框架核心要素"><a href="#框架核心要素" class="header-anchor">#</a> 框架核心要素</h2> <h3 id="良好的开发体验"><a href="#良好的开发体验" class="header-anchor">#</a> 良好的开发体验</h3> <h4 id="错误提示"><a href="#错误提示" class="header-anchor">#</a> 错误提示</h4> <p>Vue 提供了友好的警告，源码中经常能够看到 warn 函数的调用 例如</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">warn</span><span class="token punctuation">(</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to mount app: mount target selector &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>container<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;returned null.</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">)</span>
</code></pre></div><h4 id="控制台输出结果"><a href="#控制台输出结果" class="header-anchor">#</a> 控制台输出结果</h4> <p>Vue3 打印一个 ref 数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
</code></pre></div><img src="/Chulan-Blog/assets/img/core1.fc1a8ddf.png" class="zoom-custom-imgs"> <p>浏览器运行编写自定义的 formatter，从而自定义输出形式，Vue3 的源码中也有 initCustomFormatter 函数，该函数就是用来在开发环境下初始化自定义 formatter 的。</p> <p>以 Chrome 为例，打开 DevTools,勾选 Console =&gt; Enable custom formatters</p> <img src="/Chulan-Blog/assets/img/core2.34a3444f.png" width="25%" class="zoom-custom-imgs"> <p>然后刷新浏览器并查看控制台</p> <img src="/Chulan-Blog/assets/img/core3.8c687806.png" width="20%" class="zoom-custom-imgs"> <h3 id="控制框架代码体积"><a href="#控制框架代码体积" class="header-anchor">#</a> 控制框架代码体积</h3> <p>Vue 源码中 warn 函数调用都会配合 <strong>DEV</strong> 常量的检查，例如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to mount app: mount target selector &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>container<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;returned null.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Vue 使用的是 rollup 对项目进行构建，<strong>DEV</strong> 常量通过 rollup 的插件配置来预定义，类似 webpack 中的 DefinePlugin 插件</p> <p>这样就可以输出两个版本的资源，vue.global.js（开发环境），vue.global.prod.js（生产环境）</p> <h3 id="良好的tree-shaking"><a href="#良好的tree-shaking" class="header-anchor">#</a> 良好的Tree-Shaking</h3> <p>实现 Tree-Shaking 必须满足两个条件</p> <ol><li>模块必须是 ESM（ES Module）</li> <li>没有副作用</li></ol> <p>由于静态分析 JavaScript 很困难，所以像 rollup 这类工具都会应该 <code>魔法注释（/*#__PURE__*/）</code> 代码来告诉 rollup 当前代码不会产生副作用，如</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>foo<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span>

<span class="token comment">/*#__PURE__*/</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>该注释不仅仅作用于函数，它可以应用于任何语句上<br>
该注释也不是只有 rollup 才能识别，webpack 以及压缩工具（如 terser）都能识别它</p></div> <h3 id="构建产物输出"><a href="#构建产物输出" class="header-anchor">#</a> 构建产物输出</h3> <p>可以在 rollup.config.js 文件配置 format 属性来制定输出模块形式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// rollup.config.js</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">'input.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token string">'output.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'iife'</span> <span class="token comment">// 指定模块形式 iife esm cjs</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> config
</code></pre></div><h4 id="iife-vue-global-js"><a href="#iife-vue-global-js" class="header-anchor">#</a> IIFE（vue.global.js）</h4> <p>作为全局全量Vue使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;/path/to/vue.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token operator">=</span> Vue
<span class="token comment">// ...</span>
</code></pre></div><h4 id="esm-vue-esm-browser-js"><a href="#esm-vue-esm-browser-js" class="header-anchor">#</a> ESM（vue.esm-browser.js）</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;/path/to/vue.esm-browser.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>其中 <code>-browser</code> 是指 ESM 打包资源给谁使用，如上述 <code>-browser</code> 表示打包资源直接给 <code>&lt;script type=&quot;module&quot;&gt;</code>，另外还有</p> <p><code>-bundler</code> 是指 ESM 打包资源给 rollup 或者 webpack 等打包工具使用的</p> <p>区别：</p> <ol><li>Tres-Shaking 的时候，带有 -browser 的 ESM 资源中的 <strong>DEV</strong> 在开发环境中会直接替换为 true，生产环境中替换为 false</li> <li>带有 -bundler 的 ESM 资源中不能直接设置 <strong>DEV</strong>，而是使用 <code>process.env.NODE_ENV !=='production')</code> 替换 <strong>DEV</strong> 常量</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// -browser</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">useCssModule() is not supported in the global build.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// -bundler</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">useCssModule() is not supported in the global build.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="cjs"><a href="#cjs" class="header-anchor">#</a> CJS</h4> <p>除了可以直接使用 <code>&lt;script&gt;</code>标签引入资源外，我们还希望用户可以在 Node.js 中通过 require 语句引用资源，例如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>
</code></pre></div><p>这么做的答案就是 <code>服务端渲染</code>。当进行服务端渲染时，Vue.js 的代码是在 Node.js 环境中运行的，而非浏览器环境。在Node.js 环境中，资源的模块格式应该是 CommonJS，简称 cjs</p> <h3 id="特性开关"><a href="#特性开关" class="header-anchor">#</a> 特性开关</h3> <p>在设计框架时，框架会给用户提供诸多特性（或功能），例如我们提供 A、B、C 三个特性给用户，同时还提供了 a、b、c 三个对应的特性开关，用户以通过设置 a、b、c 为 true 或 false 来代表开启或关闭对应的特性，这将会带来很多益处</p> <ul><li>对于用户关闭的特性，我们可以利用 Tree-Shaking 机制让其不包含在最终的资源中。</li> <li>该机制为框架设计带来了灵活性，可以通过特性开关任意为框架添加新的特性，而不用担心资源体积变大。同时，当框架升级时，我们也可以通过特性开关来支持遗留 API，这样新用户可以选 择不使用遗留 API，从而使最终打包的资源体积最小化。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// rollup 配置 </span>
<span class="token punctuation">{</span>
  <span class="token literal-property property">__FEATURE_OPTIONS_API__</span><span class="token operator">:</span> isBundlerESMBuild <span class="token operator">?</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__VUE_OPTIONS_API__</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// webpack.DefinePlugin 插件配置</span>
<span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">__VUE_OPTIONS_API__</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 开启特性</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>其中 <code>__FEATURE_OPTIONS_API__</code> 开关是控制 vue3的 Composition API 特性，<code>__VUE_OPTIONS_API__</code> 开关是控制 vue2的 Option Api 特性</p> <h3 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> 错误处理</h3> <p>框架错误处理机制的好坏直接决定了用户应用程序的健壮性，还决定了用户开发时处理错误的心智负担。</p> <p>比如 Vue 中提供了 registerErrorHandler 函数，用户可以使用它注册错误处理程序，然后在 callWithErrorHandling 函数内部捕获错误后，把错误传递给用户注册的错误处理程序</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// utils.js</span>
<span class="token keyword">let</span> handleError <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">callWithErrorHandling</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 用户可以调用该函数注册统一的错误处理函数</span>
  <span class="token function">registerErrorHandler</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handleError <span class="token operator">=</span> fn
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">callWithErrorHandling</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    fn <span class="token operator">&amp;&amp;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将捕获到的错误传递给用户的错误处理程序</span>
    <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// index.js</span>
<span class="token keyword">import</span> utils <span class="token keyword">from</span> <span class="token string">'utils.js'</span>
<span class="token comment">// 注册错误处理程序</span>
utils<span class="token punctuation">.</span><span class="token function">registerErrorHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
utils<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
utils<span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="良好的-typescript-类型支持"><a href="#良好的-typescript-类型支持" class="header-anchor">#</a> 良好的 TypeScript 类型支持</h3> <p>误区：使用 TS 编写框架，就等价于对 TS 类型支持友好</p> <p>比如</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">val</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> val
<span class="token punctuation">}</span>
</code></pre></div><img src="/Chulan-Blog/assets/img/core4.8f1478ac.png" class="zoom-custom-imgs"> <p>在调用 foo 函数时，我们传递了一个字符串类型的参数 'str'，按照之前的分析，得到的结果 res 的类型应该也是字符串类型，然而当我们把鼠标指针悬浮到 res 常量上时，可以看到其类型是 any，这并不是我们想要的结果</p> <p>为了达到理想状态，我们只需要对 foo 函数做简单的修改即可</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> foo<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>val<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> val
<span class="token punctuation">}</span>
</code></pre></div><img src="/Chulan-Blog/assets/img/core5.68aa484f.png" class="zoom-custom-imgs"> <p>可以看到，res 的类型是字符字面量 'str' 而不是 any 了，这说明我们的代码生效了</p> <div class="sideTitle" data-v-5c6c915c><div class="title" data-v-5c6c915c>Vue设计与实现笔记</div> <hr data-v-5c6c915c> <ul data-v-5c6c915c><li class="level-2" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#设计理念" data-v-5c6c915c>设计理念</a></li><li class="level-3" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#命令式和声明式" data-v-5c6c915c>命令式和声明式</a></li><li class="level-3" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#性能与可维护性" data-v-5c6c915c>性能与可维护性</a></li><li class="level-3" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#虚拟-dom-性能到底如何" data-v-5c6c915c>虚拟 DOM 性能到底如何</a></li><li class="level-3" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#运行时和编译时" data-v-5c6c915c>运行时和编译时</a></li><li class="level-2" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#框架核心要素" data-v-5c6c915c>框架核心要素</a></li><li class="level-3" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#良好的开发体验" data-v-5c6c915c>良好的开发体验</a></li><li class="level-3" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#控制框架代码体积" data-v-5c6c915c>控制框架代码体积</a></li><li class="level-3" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#良好的tree-shaking" data-v-5c6c915c>良好的Tree-Shaking</a></li><li class="level-3" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#构建产物输出" data-v-5c6c915c>构建产物输出</a></li><li class="level-3" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#特性开关" data-v-5c6c915c>特性开关</a></li><li class="level-3" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#错误处理" data-v-5c6c915c>错误处理</a></li><li class="level-3" data-v-5c6c915c><a href="/Chulan-Blog/vue/concept/#良好的-typescript-类型支持" data-v-5c6c915c>良好的 TypeScript 类型支持</a></li></ul></div> <p>ugc 情节树</p> <p>section_type
1 Scene Block
2 Branch Block</p> <p>choice 分支存在 choice 数组中</p> <p>content   choice name</p> <p>英语语法</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/Chulan-Blog/assets/js/app.fcfd34cd.js" defer></script><script src="/Chulan-Blog/assets/js/3.cc92fa6a.js" defer></script><script src="/Chulan-Blog/assets/js/5.4311ba71.js" defer></script><script src="/Chulan-Blog/assets/js/16.c7bb5e85.js" defer></script>
  </body>
</html>
